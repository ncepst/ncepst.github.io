# バンドギャップリファレンス回路・定電圧源・定電流源（アナログ回路設計メモ）

> 目的：IC内部で「温度や電源変動に強い基準」を作るための考え方を、回路の形（トポロジ）と設計観点（誤差要因）から整理する。  
> 注：数式や係数は一般的な近似に基づく説明で、プロセスや温度範囲で係数が変わる前提です。

---

## 0. なぜ“基準”が必要か

アナログICでは、増幅器・ADC/DAC・LDO・PLL・センサIFなど、ほぼ全てが「何かの基準」に依存します。

- **基準電圧**：ADCのフルスケール、LDOの出力設定、コンパレータ閾値など
- **基準電流**：バイアス電流、gm設定、発振器の充放電電流、電流ミラーの“元”
- **要求特性**：  
  - 電源変動に強い（PSRR）  
  - 温度変動に強い（TC = Temperature Coefficient）  
  - 製造ばらつきに強い（トリム可能/設計で吸収）  
  - ノイズが低い、起動が確実、消費電力が小さい

“定電圧源/定電流源”は、この基準の作り方・配り方の総称、と捉えると整理しやすいです。

---

## 1. 定電圧源（Voltage Reference）の基本

### 1.1 代表的な選択肢
- **ツェナー/アバランシェ系（高電圧向け）**  
  数V以上の電源がある場合に使いやすいことがありますが、CMOS低電圧では使いにくいことが多いです。
- **V\_BE基準（BJT）**  
  V\_BEは温度で下がる（CTAT）ので、そのままだと温度依存が強め。
- **バンドギャップ（Bandgap）**  
  CTAT（V\_BE）とPTAT（ΔV\_BE）を加算して温度係数を相殺して、**約1.2V近辺の基準**を作るのが典型です。
- **サブバンドギャップ（Sub-1V Reference）**  
  1V以下の基準が欲しい場合、BGRを“スケール”したり、抵抗分圧・電流モード・曲率補償など工夫します。

### 1.2 “定電圧”の意味は「理想電源」ではない
実際は、次の揺らぎが必ずあります。
- **ラインレギュレーション**（電源変化でVrefが動く）
- **ロードレギュレーション**（負荷電流でVrefが動く）
- **温度係数（TC）**
- **ノイズ**（広帯域 + 1/f）
- **起動/メタステーブル**（特にBGRは“ゼロ電流解”があり得る）

---

## 2. 定電流源（Current Reference / Current Source）の基本

### 2.1 定電流源を作る王道：抵抗に“定電圧”をかける
最も直感的には
- **Iref = Vref / R**
です。Vrefが温度/電源で安定なら、Irefも安定になります。

ただし実際はRが温度係数（TCR）を持つため、
- VrefのTC
- 抵抗のTCR
- オペアンプ/ミラーの誤差
が合成されます。

### 2.2 MOSだけで作る定電流（ただし温度依存は出やすい）
- 例：MOSのVgsや閾値Vthを使って電流を決める  
  → Vthやμ（移動度）が温度で動くので、TCが大きくなりやすい傾向があります。  
  “消費電力/面積/電圧ヘッドルーム”優先で選ばれることはあります。

### 2.3 電流ミラーは“配る道具”
Irefを作ったら、電流ミラーで各ブロックへ配ります。ここで重要なのは：
- **出力抵抗 ro（チャネル長変調）**：電圧依存で電流が変わる
- **ミスマッチ**：W/Lのばらつき、レイアウト起因
- **カスコード**：ro改善（ただしヘッドルーム消費）
- **ミラーのPSRR**：電源リップルが電流に乗る

---

## 3. バンドギャップリファレンス（BGR）の中身

### 3.0 PTAT回路

$$ I_0 = I_s exp(\frac{qV_X}{kT})$$

$$ I_0 = NI_s exp(\frac{qV_Y}{kT})$$

$$ I_0 = \frac{V_X-V_Y}{R} $$

を解いて、

$$ I_0 = \frac{kT}{qR}log(N) $$

（参考: Razavi 応用編）

### 3.1 コア原理：CTAT + PTAT = ほぼ温度フラット
BJT（寄生PNPなどを含む）を使う典型BGRでは：

- **V\_BE（T）**：温度が上がると下がる（CTAT, negative TC）
- **ΔV\_BE（T）**：異なる電流密度のBJTのV\_BE差  
  \[
  \Delta V_{BE} = \frac{kT}{q}\ln(N)
  \]
  これは温度に比例（PTAT）

よって、抵抗比でスケールして
\[
V_{REF} = V_{BE} + \alpha \Delta V_{BE}
\]
とし、一次温度係数が最小になるように **α（抵抗比）を選ぶ**のが基本です。

典型的に、室温近辺でうまく合わせると **Vref ≈ 1.2V** 近辺になります（シリコンのバンドギャップ由来の“偶然の一致”に近い背景があります）。

---

## 3.2 典型トポロジ（ざっくり）
よくある“抵抗2本＋BJT2個”型は、以下の考え方です：

1. BJT A と B に **電流密度比 N** を作る（面積比 or 電流比）
2. その差のΔV\_BEを抵抗に載せて **PTAT電流**を作る  
   \[
   I_{PTAT} = \frac{\Delta V_{BE}}{R}
   \]
3. PTAT電流を別の抵抗に流して **PTAT電圧**に変換し、V\_BEに足す  
   \[
   V_{REF} = V_{BE} + I_{PTAT}\cdot R_2
   = V_{BE} + \frac{R_2}{R_1}\Delta V_{BE}
   \]
4. これを成立させるために **アンプ（誤差増幅器）**でループを組む

“アンプ＋BJT＋抵抗”で閉ループを作るので、BGRは実質「小さなアナログ制御系」です。

---

## 3.3 起動回路（スタートアップ）が必須になりがち
BGRのループ方程式は、**ゼロ電流でも成り立つ**（全素子がOFF）場合があり、
- 電源投入後に“何も起きず”ゼロ電流解に張り付く
ことが起き得ます。

そこで起動回路を入れて、
- 電源投入直後だけ少し電流を注入して動作点へ押し上げる
- 定常時は悪影響（オフセット、ノイズ、消費電力）を最小化
を狙います。

---

## 3.4 誤差要因（設計で効いてくるところ）
BGRを“式どおり”作っても、実際のVrefは以下で動きます。

### (A) 抵抗比誤差（最重要級）
- 絶対値よりも **比（R2/R1）**が効く
- レイアウトでのマッチングが大事（共通中心、ダミー、対称配線）

### (B) BJTの理想式からのズレ
- エミッタ抵抗、ベース電流、有限β、寄生抵抗
- ΔV\_BEの“ログ直線性”が完全でない可能性

### (C) アンプのオフセット
- ループが「ΔV\_BEを作る」こと自体をアンプで支えるため、オフセットが直接Vrefに乗りやすい
- 低オフセット設計や、トリムで吸収することが多い

### (D) 曲率（2次温度特性）
一次のTCは相殺しても、V\_BE自体の非線形成分で温度カーブが残ります。  
必要に応じて
- “曲率補償”を入れる
- 温度範囲を割り切る
- デジタルトリムで補正する
などを検討します。

### (E) ノイズ
- 抵抗の熱雑音（4kTRB）
- アンプの入力換算雑音（1/f含む）
- 参照点をどこでフィルタするか（C追加、帯域制限）  
  ※ただし立ち上がり時間とトレードオフ

---

## 4. 定電圧源としてBGRを使うときの実務ポイント

### 4.1 “1.2V”をそのまま使えないケース
低電圧（例：1.0V動作）だと、1.2V基準はそのまま出せません。
- BGRコアは電流基準として動かし、出力は分圧・スケールしてサブ1Vへ
- “サブバンドギャップ”アーキテクチャを使う
などの選択になります（ここは要求仕様で最適解が変わりやすいです）。

### 4.2 PSRRの取り方
BGRコアだけでPSRRを稼ぐのは難しいことが多く、
- バイアスの作り方
- アンプ電源のリップル感度
- 出力バッファ（フォロワ/OTA）  
で大きく変わります。

---

## 5. 定電流源の設計ポイント（BGRとセットで考える）

### 5.1 Iref = Vref / R の落とし穴
- Vrefが温度フラットでも、Rが温度で増える/減る  
  → IrefのTCは **-TCR** 成分を持つ
- よって「電流を温度フラット」にしたいなら、
  - 低TCR抵抗を使う
  - 抵抗の組み合わせでTCRを相殺する
  - あえてVref側にTCを残してIのTCをゼロにする  
  など、設計方針が分かれます（どれが正しいかは仕様次第です）。

### 5.2 電流ミラー配線・レイアウト
- ミラーのゲート配線抵抗、IRドロップ、温度勾配でミスマッチが出ます
- 大電流を配るなら“配電設計”そのものが重要になります

---

## 6. 最小の設計フロー（思考の順番）

1. **仕様を固定**  
   - Vref値、温度範囲、許容TC、電源範囲、消費電力、ノイズ、起動時間、面積
2. **アーキテクチャ選択**  
   - BGRか、サブBGRか、単純Vgs/Rか、外付け基準か
3. **誤差予算（エラーバジェット）**  
   - 抵抗比、アンプオフセット、BJT非理想、ミスマッチ、トリム分
4. **回路設計**  
   - ループ利得、安定性、起動、PSRR、ノイズ
5. **レイアウト戦略**  
   - マッチング、ガードリング、共通中心、配線対称、熱勾配対策
6. **シミュレーション**  
   - PVT + Monte Carlo + 温度掃引 + 起動（コールド/ホット）  
   - PSRR/ノイズ/ライン・ロード変動
7. **トリム設計（必要なら）**  
   - 抵抗トリム、デジタルトリム、温度点トリム方式

---

## 7. 参考：用語ミニ辞典
- **PTAT**：Proportional To Absolute Temperature（温度に比例）
- **CTAT**：Complementary To Absolute Temperature（温度に反比例的/負の温度係数）
- **TC**：Temperature Coefficient（ppm/°Cなど）
- **PSRR**：Power Supply Rejection Ratio（電源変動除去）
- **Line/Load regulation**：電源/負荷変動での出力変化
- **Curvature**：一次補償後に残る2次温度特性

---

## 8. 次に深掘りすると良い論点（設計者視点）
- BGRアンプの入力共通モード範囲（低電圧で詰むポイントになりやすい）
- BJTの取り方（縦型/横型/寄生PNP）とβ、ベース電流補償
- 2次曲率補償の方法（温度範囲と手間の最適点）
- “電流基準”を先に作るか、“電圧基準”を先に作るか（配りやすさが変わる）
- ノイズとフィルタ容量のトレードオフ（起動時間・安定性も絡む）

---

## 付録A：超ざっくり設計の勘所（一次TCの合わせ方のイメージ）
一次的には、
- V\_BEの温度係数（負）と
- (R2/R1)·ΔV\_BEの温度係数（正）
を足してゼロに近づけます。

ただし現実には
- 抵抗比誤差
- アンプオフセット
- BJTの非理想
- 曲率
が効くので、設計では「理想式で合わせたあと、どの誤差がどれだけ動かすか」を積み上げていくことが多いです。

---
