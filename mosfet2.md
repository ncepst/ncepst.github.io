## W / L を増やすと容量が支配的になる理由（実務視点）

### ${ g_m }$ とデバイス寸法の関係

強反転・長チャネル・平方則モデルを仮定すると，MOSFET のトランスコンダクタンスは

$$
g_m = \sqrt{ 2 \mu C_{\mathrm{ox}} \frac{ W }{ L } I_D }
$$

で与えられる。

この式はモデルの仮定下では **等式**であり，設計初期の見積りに広く用いられる。

一方，ゲート関連の寄生容量はデバイス寸法に比例し，

$$
C_{gs} \propto W L
$$

$$
C_{gd} \propto W L
$$

と近似できる。

---

### ${ W / L }$ を増やしたときの実際の変化

バイアス電流 ${ I_D }$ を一定に保ったまま ${ W / L }$ を増やすと，

- ${ g_m }$ は ${ \sqrt{ W / L } }$ に比例して増加する  
- 寄生容量 ${ C }$ はほぼ ${ W }$ に比例して増加する  

という **非対称なスケーリング**が起こる。

実務的には，

> 「 ${ g_m }$ はそこそこ増えるが，容量は確実に増える」

と覚えるのが安全である。

---

### 極の位置と帯域への影響

出力ノードの等価抵抗を ${ r_o }$，容量を ${ C }$ とすると，
このノードの極は

$$
f_p = \frac{ 1 }{ 2 \pi r_o C }
$$

で与えられる。

したがって ${ W }$ を大きくして ${ C }$ が増加すると，

$$
C \uparrow \Rightarrow f_p \downarrow
$$

となり，極は低周波側へ移動する。

実務ではこの結果として，

- DC 利得はほぼ同じ  
- 高周波でのロールオフ開始が早くなる  

という現象が観測される。

---

### 設計判断としてのポイント

- 「利得が足りない」からといって安易に ${ W }$ を増やすと，
  帯域と位相余裕が悪化しやすい  
- 利得は ${ g_m r_o }$，帯域は容量で決まる，という分離した視点が重要  

---

## ミラー補償と等価容量（設計で何が起きているか）

### ミラー効果の本質

入力ノードと出力ノードの間に容量 ${ C_{gd} }$ が存在し，
その両端の電圧利得を ${ A_v }$ とすると，
入力側から見た等価容量は

$$
C_{\mathrm{eq}} = C_{gd} ( 1 - A_v )
$$

で与えられる。

共通ソース増幅段では ${ A_v < 0 }$ であるため，

$$
C_{\mathrm{eq}} \approx C_{gd} ( 1 + | A_v | )
$$

となり，容量が大きく「見える」。

---

### ミラー補償容量 ${ C_c }$ の役割

2 段オペアンプでは，
第 1 段出力と第 2 段出力の間に補償容量 ${ C_c }$ を入れることが多い。

このとき第 1 段出力ノードから見た等価容量は

$$
C_{\mathrm{eq}} \approx C_c ( 1 + A_2 )
$$

となる（${ A_2 }$ は第 2 段利得）。

実務的には，

> 「${ C_c }$ は ${ 1 + A_2 }$ 倍に増幅されて第 1 段にぶら下がる」

と理解する。

---

### 支配極を「作る」という考え方

第 1 段出力ノードの等価抵抗を ${ r_{o1} }$ とすると，
ここに形成される極は

$$
f_{p1} = \frac{ 1 }{ 2 \pi r_{o1} C_{\mathrm{eq}} }
$$

である。

ミラー補償ではこの極を **意図的に低周波側へ配置**し，

- 他の極が効く前に利得を十分下げる  
- 位相遅れを 1 極分に近づける  

ことを目的とする。

---

## ゲイン帯域と GBW（設計で使う指標）

### ゲイン帯域の意味

単一極近似が成り立つ増幅器では，
開ループ伝達関数は

$$
A ( j \omega ) = \frac{ A_0 }{ 1 + j \frac{ \omega }{ \omega_p } }
$$

と表される。

このとき，

- 低周波では利得はほぼ ${ A_0 }$  
- 周波数が上がると ${ -20 \,\mathrm{dB/dec} }$ で減衰  

する。

**ゲイン帯域**とは，
「ある利得を維持できる周波数範囲」を指す実務的な言葉である。

---

### ユニティゲイン周波数と GBW

ユニティゲイン周波数 ${ \omega_u }$ は，

$$
| A ( j \omega_u ) | = 1
$$

を満たす角周波数である。

単一極近似の下では，

$$
\omega_u \approx A_0 \omega_p
$$

が成り立ち，周波数表示では

$$
f_u \approx A_0 f_p
$$

となる。

この ${ f_u }$ を **GBW（ Gain Bandwidth Product ）**と呼ぶ。

---

### ${ g_m }$ と GBW の関係

共通ソース段では，

$$
A_0 \approx g_m r_o
$$

$$
f_p \approx \frac{ 1 }{ 2 \pi r_o C }
$$

であるため，

$$
GBW = A_0 f_p \approx \frac{ g_m }{ 2 \pi C }
$$

となる。

---

### 実務的な解釈

この式が意味するのは，

- ${ r_o }$ を上げても GBW は増えない  
- GBW を決めているのは **${ g_m }$ と容量 ${ C }$**  

という事実である。

そのため設計では，

> 「どの段の ${ g_m }$ で，どの容量を駆動しているか」

を常に意識する必要がある。

---

## LTspice での確認ポイント

- `.op` 解析で ${ g_m }$，${ r_o }$ を確認  
- `.ac` 解析で  
  - 支配極の位置  
  - ユニティゲイン周波数  
  - 位相余裕  
  を同時に観測する  
-  ${ I_D }$ ， ${ W }$ ， ${ C_c }$ を変え，
  「どこが効いて特性が変わったか」を言語化する  

---

## まとめ（設計者視点）

- ${ g_m }$ は「容量を動かす力」  
- ${ W / L }$ 増加は利得と容量を同時に増やす  
- 安定性は「自然に得られる」ものではなく「作る」もの  
- GBW は **トランジスタレベルの設計判断**の結果として決まる  

これらを数式・回路・シミュレーションの三点で結びつけることが，
実務的なアナログ回路設計の基本である。

## 位相余裕と安定性（実務設計で最も重要な指標）

### 位相余裕とは何か

負帰還増幅器では，開ループ利得が 1 になる周波数での位相遅れが
安定性を決定する。

ユニティゲイン周波数 ${ \omega_u }$ における位相を ${ \angle A ( j \omega_u ) }$ とすると，
位相余裕（phase margin）は

$$
\mathrm{PM} = 180^\circ + \angle A ( j \omega_u )
$$

で定義される。

---

### 位相余裕の実務的な目安

一般的なアナログ回路設計では，

- ${ \mathrm{PM} \approx 60^\circ }$ ：十分安定（推奨）
- ${ \mathrm{PM} \approx 45^\circ }$ ：実用限界
- ${ \mathrm{PM} < 30^\circ }$ ：リンギング・発振の危険あり

とされる。

位相余裕は「安全率」であり，
性能を攻めるほど小さくなりがちである。

---

## なぜ位相が遅れるのか（極の重なり）

### 単一極の場合

単一極のみを持つ系では，
位相遅れは高周波で最大でも

$$
-90^\circ
$$

である。

このため，
ユニティゲイン点での位相余裕は十分に確保される。

---

### 多極の場合

極が 2 個以上存在すると，

- 2 極で最大 ${ -180^\circ }$
- 3 極で最大 ${ -270^\circ }$

の位相遅れが生じ得る。

ユニティゲイン周波数付近で
複数の極が効いていると，
位相余裕は急激に悪化する。

---

## ミラー補償で現れる零点

### ミラー補償の副作用

ミラー補償容量 ${ C_c }$ は，
支配極を作る一方で，
新たな零点を発生させる。

その零点の角周波数は近似的に

$$
\omega_z \approx \frac{ g_{m2} }{ C_c }
$$

で与えられる。

ここで ${ g_{m2} }$ は第 2 段のトランスコンダクタンスである。

---

### 零点の影響

この零点が右半平面零点（RHP zero）となる場合，

- 利得は増えるが
- 位相は **さらに遅れる**

という，安定性にとって不利な特性を持つ。

その結果，

- 位相余裕の低下
- 高周波での不安定化

が起こりやすくなる。

---

### 実務での対処法

実務では次のような対策を取る。

- ${ g_{m2} }$ を過度に大きくしない
- ${ C_c }$ を適切に選ぶ
- 零点キャンセル抵抗を用いる
- 出力段をソースフォロワ構成にする

設計とは，
**極と零点の配置を制御する作業**
である。

---

## 実務的な設計フロー（2 段オペアンプ）

### 手順 1：GBW を決める

まず目標とする GBW を仕様から決める。

$$
GBW_{\mathrm{target}}
$$

---

### 手順 2：補償容量 ${ C_c }$ を仮決めする

プロセスや面積制約を考慮し，
実装可能な ${ C_c }$ を仮定する。

---

### 手順 3：必要な ${ g_{m1} }$ を計算する

支配極を駆動する段の ${ g_{m1} }$ は，

$$
g_{m1}
\approx
2 \pi C_c \, GBW_{\mathrm{target}}
$$

から求める。

---

### 手順 4：バイアス電流を決める

平方則モデルを仮定すると，

$$　
g_{m1}=\sqrt{2 \mu C_{\mathrm{ox}} \frac{ W }{ L } I_D } 
$$

より，
必要な ${ I_D }$ と ${ W / L }$ の組を決定する。

---

### 手順 5：AC 解析で検証する

LTspice にて `.ac` 解析を行い，

- ユニティゲイン周波数
- 位相余裕
- 支配極の位置

を確認する。

設計値とずれる場合は，

- ${ C_c }$
- ${ I_D }$
- ${ W / L }$

を再調整する。

---

## LTspice での実務的チェックリスト

- ユニティゲイン点で位相余裕 ${ \ge 60^\circ }$
- 2 番目の極が ${ \omega_u }$ の 3〜5 倍以上
- 零点が ${ \omega_u }$ より十分高周波
- 過渡解析でリンギングが過大でない

---

## まとめ（安定性設計の本質）

- 位相余裕は「あと何度余っているか」
- 安定性は **極と零点の配置問題**
- ミラー補償は万能ではなく，副作用を持つ
- 数式 → 回路 → シミュレーションの往復が不可欠

安定なオペアンプは，
偶然ではなく **意図して作られる**。

これが実務における
アナログ回路設計の核心である。
