## W / L を増やすと容量が支配的になる理由（実務視点）

### ${ g_m }$ とデバイス寸法の関係

強反転・長チャネル・平方則モデルを仮定すると，MOSFET のトランスコンダクタンスは

$$
g_m = \sqrt{ 2 \mu C_{\mathrm{ox}} \frac{ W }{ L } I_D }
$$

で与えられる。

この式はモデルの仮定下では **等式**であり，設計初期の見積りに広く用いられる。

一方，ゲート関連の寄生容量はデバイス寸法に比例し，

$$
C_{gs} \propto W L
$$

$$
C_{gd} \propto W L
$$

と近似できる。

---

### ${ W / L }$ を増やしたときの実際の変化

バイアス電流 ${ I_D }$ を一定に保ったまま ${ W / L }$ を増やすと，

- ${ g_m }$ は ${ \sqrt{ W / L } }$ に比例して増加する  
- 寄生容量 ${ C }$ はほぼ ${ W }$ に比例して増加する  

という **非対称なスケーリング**が起こる。

実務的には，

> 「 ${ g_m }$ はそこそこ増えるが，容量は確実に増える」

と覚えるのが安全である。

---

### 極の位置と帯域への影響

出力ノードの等価抵抗を ${ r_o }$，容量を ${ C }$ とすると，
このノードの極は

$$
f_p = \frac{ 1 }{ 2 \pi r_o C }
$$

で与えられる。

したがって ${ W }$ を大きくして ${ C }$ が増加すると，

$$
C \uparrow \Rightarrow f_p \downarrow
$$

となり，極は低周波側へ移動する。

実務ではこの結果として，

- DC 利得はほぼ同じ  
- 高周波でのロールオフ開始が早くなる  

という現象が観測される。

---

### 設計判断としてのポイント

- 「利得が足りない」からといって安易に ${ W }$ を増やすと，
  帯域と位相余裕が悪化しやすい  
- 利得は ${ g_m r_o }$，帯域は容量で決まる，という分離した視点が重要  

---

## ミラー補償と等価容量（設計で何が起きているか）

### ミラー効果の本質

入力ノードと出力ノードの間に容量 ${ C_{gd} }$ が存在し，
その両端の電圧利得を ${ A_v }$ とすると，
入力側から見た等価容量は

$$
C_{\mathrm{eq}} = C_{gd} ( 1 - A_v )
$$

で与えられる。

共通ソース増幅段では ${ A_v < 0 }$ であるため，

$$
C_{\mathrm{eq}} \approx C_{gd} ( 1 + | A_v | )
$$

となり，容量が大きく「見える」。

---

### ミラー補償容量 ${ C_c }$ の役割

2 段オペアンプでは，
第 1 段出力と第 2 段出力の間に補償容量 ${ C_c }$ を入れることが多い。

このとき第 1 段出力ノードから見た等価容量は

$$
C_{\mathrm{eq}} \approx C_c ( 1 + A_2 )
$$

となる（${ A_2 }$ は第 2 段利得）。

実務的には，

> 「${ C_c }$ は ${ 1 + A_2 }$ 倍に増幅されて第 1 段にぶら下がる」

と理解する。

---

### 支配極を「作る」という考え方

第 1 段出力ノードの等価抵抗を ${ r_{o1} }$ とすると，
ここに形成される極は

$$
f_{p1} = \frac{ 1 }{ 2 \pi r_{o1} C_{\mathrm{eq}} }
$$

である。

ミラー補償ではこの極を **意図的に低周波側へ配置**し，

- 他の極が効く前に利得を十分下げる  
- 位相遅れを 1 極分に近づける  

ことを目的とする。

---

## ゲイン帯域と GBW（設計で使う指標）

### ゲイン帯域の意味

単一極近似が成り立つ増幅器では，
開ループ伝達関数は

$$
A ( j \omega ) = \frac{ A_0 }{ 1 + j \frac{ \omega }{ \omega_p } }
$$

と表される。

このとき，

- 低周波では利得はほぼ ${ A_0 }$  
- 周波数が上がると ${ -20 \,\mathrm{dB/dec} }$ で減衰  

する。

**ゲイン帯域**とは，
「ある利得を維持できる周波数範囲」を指す実務的な言葉である。

---

### ユニティゲイン周波数と GBW

ユニティゲイン周波数 ${ \omega_u }$ は，

$$
| A ( j \omega_u ) | = 1
$$

を満たす角周波数である。

単一極近似の下では，

$$
\omega_u \approx A_0 \omega_p
$$

が成り立ち，周波数表示では

$$
f_u \approx A_0 f_p
$$

となる。

この ${ f_u }$ を **GBW（ Gain Bandwidth Product ）**と呼ぶ。

---

### ${ g_m }$ と GBW の関係

共通ソース段では，

$$
A_0 \approx g_m r_o
$$

$$
f_p \approx \frac{ 1 }{ 2 \pi r_o C }
$$

であるため，

$$
GBW = A_0 f_p \approx \frac{ g_m }{ 2 \pi C }
$$

となる。

---

### 実務的な解釈

この式が意味するのは，

- ${ r_o }$ を上げても GBW は増えない  
- GBW を決めているのは **${ g_m }$ と容量 ${ C }$**  

という事実である。

そのため設計では，

> 「どの段の ${ g_m }$ で，どの容量を駆動しているか」

を常に意識する必要がある。

---

## LTspice での確認ポイント

- `.op` 解析で ${ g_m }$ ，${ r_o }$ を確認  
- `.ac` 解析で  
  - 支配極の位置  
  - ユニティゲイン周波数  
  - 位相余裕  
  を同時に観測する  
-  ${ I_D }$ ， ${ W }$ ， ${ C_c }$ を変え，
  「どこが効いて特性が変わったか」を言語化する  

---

## まとめ（設計者視点）

- ${ g_m }$ は「容量を動かす力」  
- ${ W / L }$ 増加は利得と容量を同時に増やす  
- 安定性は「自然に得られる」ものではなく「作る」もの  
- GBW は **トランジスタレベルの設計判断**の結果として決まる  

これらを数式・回路・シミュレーションの三点で結びつけることが，
実務的なアナログ回路設計の基本である。

## 位相余裕と安定性（実務設計で最も重要な指標）

### 位相余裕とは何か

負帰還増幅器では，開ループ利得が 1 になる周波数での位相遅れが
安定性を決定する。

ユニティゲイン周波数 ${ \omega_u }$ における位相を ${ \angle A ( j \omega_u ) }$ とすると，
位相余裕（phase margin）は

$$
\mathrm{PM} = 180^\circ + \angle A ( j \omega_u )
$$

で定義される。

---

### 位相余裕の実務的な目安

一般的なアナログ回路設計では，

- ${ \mathrm{PM} \approx 60^\circ }$ ：十分安定（推奨）
- ${ \mathrm{PM} \approx 45^\circ }$ ：実用限界
- ${ \mathrm{PM} < 30^\circ }$ ：リンギング・発振の危険あり

とされる。

位相余裕は「安全率」であり，
性能を攻めるほど小さくなりがちである。

---

## なぜ位相が遅れるのか（極の重なり）

### 単一極の場合

単一極のみを持つ系では，
位相遅れは高周波で最大でも

$$
-90^\circ
$$

である。

このため，
ユニティゲイン点での位相余裕は十分に確保される。

---

### 多極の場合

極が 2 個以上存在すると，

- 2 極で最大 ${ -180^\circ }$
- 3 極で最大 ${ -270^\circ }$

の位相遅れが生じ得る。

ユニティゲイン周波数付近で
複数の極が効いていると，
位相余裕は急激に悪化する。

---

## ミラー補償で現れる零点

### ミラー補償の副作用

ミラー補償容量 ${ C_c }$ は，
支配極を作る一方で，
新たな零点を発生させる。

その零点の角周波数は近似的に

$$
\omega_z \approx \frac{ g_{m2} }{ C_c }
$$

で与えられる。

ここで ${ g_{m2} }$ は第 2 段のトランスコンダクタンスである。

零点周波数では、増幅段が作る電流をそのまま補償容量でフィードバックして、次の段への電流が0になる。  

---

### 零点の影響

この零点が右半平面零点（RHP zero）となる場合，

- 利得は増えるが
- 位相は **さらに遅れる**

という，安定性にとって不利な特性を持つ。

その結果，

- 位相余裕の低下
- 高周波での不安定化

が起こりやすくなる。

---

### 実務での対処法

実務では次のような対策を取る。

- ${ g_{m2} }$ を過度に大きくしない
- ${ C_c }$ を適切に選ぶ
- 零点キャンセル抵抗を用いる
- 出力段をソースフォロワ構成にする

設計とは，
**極と零点の配置を制御する作業**
である。

---

## 実務的な設計フロー（2 段オペアンプ）

### 手順 1：GBW を決める

まず目標とする GBW を仕様から決める。

$$
GBW_{\mathrm{target}}
$$

---

### 手順 2：補償容量 ${ C_c }$ を仮決めする

プロセスや面積制約を考慮し，
実装可能な ${ C_c }$ を仮定する。

---

### 手順 3：必要な ${ g_{m1} }$ を計算する

支配極を駆動する段の ${ g_{m1} }$ は，

$$
g_{m1} \approx 2 \pi C_c \, GBW_{\mathrm{target}}
$$

から求める。

---

### 手順 4：バイアス電流を決める

平方則モデルを仮定すると，

$$　
g_{m1}=\sqrt{2 \mu C_{\mathrm{ox}} \frac{ W }{ L } I_D } 
$$

より，
必要な ${ I_D }$ と ${ W / L }$ の組を決定する。

---

### 手順 5：AC 解析で検証する

LTspice にて `.ac` 解析を行い，

- ユニティゲイン周波数
- 位相余裕
- 支配極の位置

を確認する。

設計値とずれる場合は，

- ${ C_c }$
- ${ I_D }$
- ${ W / L }$

を再調整する。

---

## LTspice での実務的チェックリスト

- ユニティゲイン点で位相余裕 ${ \ge 60^\circ }$
- 2 番目の極が ${ \omega_u }$ の 3〜5 倍以上
- 零点が ${ \omega_u }$ より十分高周波
- 過渡解析でリンギングが過大でない

---

## まとめ（安定性設計の本質）

- 位相余裕は「あと何度余っているか」
- 安定性は **極と零点の配置問題**
- ミラー補償は万能ではなく，副作用を持つ
- 数式 → 回路 → シミュレーションの往復が不可欠

安定なオペアンプは，
偶然ではなく **意図して作られる**。

これが実務における
アナログ回路設計の核心である。

## 数値例：GBW = 10 MHz を設計する（ミラー補償 2 段オペアンプ）

### 前提（設計の置き方）

目標 GBW を次のように置く。

$$
GBW_{\mathrm{target}} = 10 \times 10^6 \ \mathrm{Hz}
$$

ミラー補償容量は実装可能性とノイズ耐性のバランスで仮決めする。
ここでは

$$
C_c = 2 \ \mathrm{pF}
$$

とする。

---

### 手順 1：必要な ${ g_{m1} }$ を計算する

ミラー補償の単一極近似が成り立つ範囲では

$$
GBW \approx \frac{ g_{m1} }{ 2 \pi C_c }
$$

より，必要な ${ g_{m1} }$ は

$$
g_{m1} \approx 2 \pi C_c \, GBW_{\mathrm{target}}
$$

数値を代入すると

$$
g_{m1} \approx 2 \pi \cdot 2 \times 10^{-12} \cdot 10 \times 10^{6} \ \mathrm{S}
$$

よって

$$
g_{m1} \approx 1.26 \times 10^{-4} \ \mathrm{S}
$$

すなわち

$$
g_{m1} \approx 0.126 \ \mathrm{mS}
$$

が目標となる。

---

### 手順 2：${ I_D }$ と ${ V_{\mathrm{ov}} }$ の設計（実務的）

平方則モデルの関係

$$
g_m = \frac{ 2 I_D }{ V_{\mathrm{ov}} }
$$

を用いると，${ V_{\mathrm{ov}} }$ を仮定することで電流が決まる。

低消費電力寄りに

$$
V_{\mathrm{ov}} = 0.2 \ \mathrm{V}
$$

と置くと，

$$
I_D = \frac{ g_m V_{\mathrm{ov}} }{ 2 }
$$

なので

$$
I_D \approx \frac{ 1.26 \times 10^{-4} \cdot 0.2 }{ 2 } \ \mathrm{A}
$$

よって

$$
I_D \approx 1.26 \times 10^{-5} \ \mathrm{A}
$$

すなわち

$$
I_D \approx 12.6 \ \mathrm{\mu A}
$$

となる。

この時点で設計メモとしては，
「第 1 段の ${ g_{m1} }$ を約 ${ 0.126 \ \mathrm{mS} }$ にするには，第 1 段の枝電流は約 ${ 12.6 \ \mathrm{\mu A} }$」
と言える。

---

### 手順 3：LTspice での検証手順（実務）

1. `.op` で第 1 段入力トランジスタの ${ g_m }$ を確認し，目標に合わせる  
2. `.ac` で開ループ利得を測定し，ユニティゲイン点が ${ 10 \ \mathrm{MHz} }$ 近辺か確認  
3. ユニティゲイン点で位相余裕が十分かを確認  
4. `.tran` でステップ応答を見てリンギングを確認  

---

## 出力段とスルーレート（SR）の関係

### スルーレートの基本式

補償容量 ${ C_c }$ が支配的なとき，
大信号では第 1 段が供給できる電流 ${ I_{\mathrm{chg}} }$ により
補償容量の充放電速度が制限される。

容量電流の関係

$$
I = C \frac{ dV }{ dt }
$$

より，スルーレートは

$$
SR \approx \frac{ I_{\mathrm{chg}} }{ C_c }
$$

となる。

---

### 数値例（上の設計値から）

第 1 段が補償容量へ供給できる電流が，
おおむね枝電流と同程度だとすると

$$
I_{\mathrm{chg}} \approx 12.6 \ \mathrm{\mu A}
$$

なので

$$
SR \approx \frac{ 12.6 \times 10^{-6} }{ 2 \times 10^{-12} } \ \mathrm{V/s}
$$

よって

$$
SR \approx 6.3 \times 10^{6} \ \mathrm{V/s}
$$

すなわち

$$
SR \approx 6.3 \ \mathrm{V/\mu s}
$$

となる。

実務的には，
GBW を上げるために ${ g_m }$ を上げる設計は，
多くの場合 ${ I_{\mathrm{chg}} }$ も増えるため SR も改善しやすいが，
${ C_c }$ を増やして安定化した場合は SR が低下しやすい，
というトレードオフがある。

---

### 出力段との関係（実務ポイント）

出力段は主に

- 負荷容量 ${ C_L }$ を駆動する能力
- 負荷電流の供給能力

を決める。

大きな ${ C_L }$ を高速に駆動するには，
出力段の供給電流 ${ I_{\mathrm{out}} }$ が支配的になり，
出力の立ち上がりは近似的に

$$
\frac{ dV_{\mathrm{out}} }{ dt } \approx \frac{ I_{\mathrm{out}} }{ C_L }
$$

で制限される。

つまり，

- 内部補償（ ${ C_c }$ ）が支配する SR  
- 外部負荷（ ${ C_L }$ ）が支配する出力スルー  

の 2 種類を区別して評価するのが実務的に重要である。

---

## 零点 ${ \omega_z \approx g_m / C }$ の導出（直感と小信号）

### 近似モデル

第 2 段をトランスコンダクタ ${ g_{m2} }$ とみなし，
補償容量 ${ C_c }$ に流れ込む電流を考える。

補償容量に流れる電流は

$$
i_c = C_c \frac{ d v }{ dt }
$$

である。

一方，第 2 段が生み出す電流は

$$
i_2 = g_{m2} v
$$

と表せる（ここで ${ v }$ は第 2 段の入力側の小信号電圧とする）。

周波数領域では

$$
i_c = j \omega C_c v
$$

となるので，両者の大きさが等しくなる境界条件

$$
| j \omega C_c v | = | g_{m2} v |
$$

より ${ v }$ が消えて

$$
\omega = \frac{ g_{m2} }{ C_c }
$$

を得る。

したがって零点の角周波数は

$$
\omega_z \approx \frac{ g_{m2} }{ C_c }
$$

となる。

---

### 実務的な意味

この式は，

- ${ g_{m2} }$ が大きいほど零点は高周波へ
- ${ C_c }$ が大きいほど零点は低周波へ

移動することを示す。

零点がユニティゲイン周波数付近に来ると，
ボード線図の傾きや位相に影響し，
位相余裕の劣化やピーキングの原因となる。

---

## なぜ実シリコンでズレるか（設計値と現実の差）

### 1：モデル仮定の破綻

平方則モデルは長チャネル近似であり，
実プロセスでは

- 速度飽和
- 移動度低下
- 短チャネル効果

により ${ g_m }$ のスケーリングが崩れる。

その結果，
計算で求めた ${ I_D }$ と ${ g_m }$ の関係がずれる。

---

### 2：寄生容量の増加と分布

設計で仮定した ${ C_c }$ 以外にも，

- 配線容量
- ドレインバルク容量
- ゲートオーバラップ容量

が加算される。

このため実効容量 ${ C_{\mathrm{eff}} }$ は

$$
C_{\mathrm{eff}} = C_c + C_{\mathrm{par}}
$$

となり，GBW や零点位置が低下しやすい。

---

### 3：有限利得段による多極化

第 1 段，第 2 段，出力段の各ノードに極があり，
支配極以外の極が予想より低周波に来ると，
位相余裕が悪化する。

実務では
「第 2 極がユニティゲイン周波数の 3 倍以上」
を目標にすることが多い。

---

### 4：プロセスばらつきと温度依存

- ${ \mu }$ の温度依存
- ${ V_{TH} }$ のばらつき
- ${ r_o }$ の変動

により，
${ g_m }$ ，GBW，SR，位相余裕が変動する。

そのため実務では，
PVT（ Process，Voltage，Temperature ）での角ケース検証を行う。

---

## まとめ（数値例から得られる設計感覚）

- GBW を決めたら ${ C_c }$ を仮定し， ${ g_{m1} }$ を逆算する  
- ${ V_{\mathrm{ov}} }$ を仮定して ${ I_D }$ を決めると設計が進む  
- SR は ${ I_{\mathrm{chg}} / C_c }$ で概算できる  
- 零点は ${ g_{m2} / C_c }$ で位置が見積もれる  
- 実シリコンでは寄生と短チャネルで「だいたい悪化する」ので，
  マージン込みの設計と PVT 検証が必須である  

